<!DOCTYPE html>
<!--
    Copyright (c) 2012-2016 Adobe Systems Incorporated. All rights reserved.

    Licensed to the Apache Software Foundation (ASF) under one
    or more contributor license agreements.  See the NOTICE file
    distributed with this work for additional information
    regarding copyright ownership.  The ASF licenses this file
    to you under the Apache License, Version 2.0 (the
    "License"); you may not use this file except in compliance
    with the License.  You may obtain a copy of the License at

    http://www.apache.org/licenses/LICENSE-2.0

    Unless required by applicable law or agreed to in writing,
    software distributed under the License is distributed on an
    "AS IS" BASIS, WITHOUT WARRANTIES OR CONDITIONS OF ANY
     KIND, either express or implied.  See the License for the
    specific language governing permissions and limitations
    under the License.
-->
<html>

<head>
    <meta charset="utf-8" />
    <meta name="format-detection" content="telephone=no" />
    <meta name="msapplication-tap-highlight" content="no" />
    <meta name="viewport" content="user-scalable=no, initial-scale=1, maximum-scale=1, minimum-scale=1, width=device-width" />
    <!-- This is a wide open CSP declaration. To lock this down for production, see below. -->
<meta http-equiv="Content-Security-Policy" content="default-src * 'unsafe-inline'; script-src * 'unsafe-inline'; object-src *; style-src 'self' 'unsafe-inline'; img-src *; media-src *; frame-src *; font-src *; connect-src *" />
<meta http-equiv="X-Content-Security-Policy" content="default-src * 'unsafe-inline'; script-src * 'unsafe-inline'; object-src *; style-src 'self' 'unsafe-inline'; img-src *; media-src *; frame-src *; font-src *; connect-src *"/>
<meta http-equiv="X-WebKit-CSP" content="default-src * 'unsafe-inline'; script-src * 'unsafe-inline'; object-src *; style-src 'self' 'unsafe-inline'; img-src *; media-src *; frame-src *; font-src *; connect-src *" /> 
    
    <!-- Good default declaration:
    * gap: is required only on iOS (when using UIWebView) and is needed for JS->native communication
    * https://ssl.gstatic.com is required only on Android and is needed for TalkBack to function properly
    * Disables use of eval() and inline scripts in order to mitigate risk of XSS vulnerabilities. To change this:
        * Enable inline JS: add 'unsafe-inline' to default-src
        * Enable eval(): add 'unsafe-eval' to default-src
    * Create your own at http://cspisawesome.com
    -->
    <!-- <meta http-equiv="Content-Security-Policy" content="default-src 'self' data: gap: 'unsafe-inline' https://ssl.gstatic.com; style-src 'self' 'unsafe-inline'; media-src *" /> -->
    <!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
    <script   src="https://code.jquery.com/jquery-3.2.1.min.js"   integrity="sha256-hwg4gsxgFZhOsEEamdOYGBf13FyQuiTwlAQgxVSNgt4="   crossorigin="anonymous"></script>
    <!-- Include all compiled plugins (below), or include individual files as needed -->
    <script src="assets/bootstrap/js/bootstrap.min.js"></script>
    <link href="assets/bootstrap/css/bootstrap.min.css" rel="stylesheet">
    <link rel="stylesheet" href="assets/font-awesome-4.7.0/css/font-awesome.min.css">
    <link rel="stylesheet" type="text/css" href="css/checkinview.css" />
 
    
    
   

    <title>BrightSpot Events</title>
</head>

<body>
        
    
    <div class="modal fade" id="new_modal" tabindex="-1" role="dialog" aria-labelledby="myModalLabel" aria-hidden="true">
        <div class="modal-dialog">
            <div class="modal-content">
                <button type="button" class="close" data-dismiss="modal" aria-hidden="true">&times;</button>
                <h4 class="" id="modal_header"></h4>
                    <!-- Modal Body -->
            <div class="modal-body">
                <form class='form_group' role="form">
                
                </form>
            </div>
                
                <button type="button" id="submit_attn" class="btn modal_btn">Submit</button>
                <button type="button" id="cancel_attn" class="btn modal_btn" data-dismiss="modal">Cancel</button>
                
            </div>
        </div>
    </div>
    
    
<!--Confirm Delete Modal-->
        <div class="modal fade" id="modaldelete" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-sm">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" id="btn-cancel" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Confirm Delete?</h4>
                </div>
                <div class="modal-body">
                    The user will be removed from this event.
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" id="btn-cancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger btn-delete" id="btn-delete" data-dismiss="modal">Delete</button>
                </div>
            </div>

        </div>
    </div>
<!--    End-->
    
    <!--Confirm Email Modal-->
        <div class="modal fade" id="modalemail" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-sm">

            <!-- Modal content-->
            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" id="btn-cancel" data-dismiss="modal">&times;</button>
                    <h4 class="modal-title">Confirm Email?</h4>
                </div>
                <div class="modal-body">
                    
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn" id="btn-cancel" data-dismiss="modal">Cancel</button>
                    <button type="button" class="btn btn-danger btn-delete" id="btn-email" data-dismiss="modal">Email</button>
                </div>
            </div>

        </div>
    </div>
<!--    End-->
    
    <!--Loading Modal-->
        <div class="modal fade" id="modal_load" role="dialog" data-backdrop="static" data-keyboard="false">
        <div class="modal-dialog modal-sm">
              
            <p id='loading'>Loading...</p>

        </div>
    </div>
<!--    End-->
    
   <div class="container-fluid">

       <div class="row">
           <div class="col-xs-12">
                 <div id="top-nav">      
                     <img id="logo" src="img/logo.png">
                     <p id="event_title">Event Text</p>
                     <button id='logout'>Logout</button>
                     
                    <!--Top Nav Area-->  
</div>
                    <!--Top Nav Area End-->
                    <!--Search Area-->
<div id="search-summary">
    <div id="summary-cont">
            <p>Summary:</p>
            <p id="chckd">Checked-in: 0</p>
            <p id="rgstrd">Registered: 0</p>
            <p id="ttlcnt">All Attendees: 0</p>
    </div>
    
    <div id="search_cont">
        
        
    <div class="input-group search">
        <input type="text" id="searchfield" class="form-control" placeholder="Search" aria-describedby="basic-addon2">
         <div class="input-group-btn">
        <button id='searchclear' class="btn btn-default" type="button"><i id="clear-symbol" class="glyphicon glyphicon-remove"></i></button>
        <button id='searchsubmit' class="btn btn-default" type="button"><i id="button-symbol" class="glyphicon glyphicon-search"></i></button>     
        </div>
        </div>
    <div id="attendeebtn_cont">    
      <button id="btnHide" type="button" class="mode_button btn">Check-In View</button>    
      <button id="attendeebtn" class="add_attendee btn">+ Add New Attendee</button>  
    </div>        
    </div>

               </div>
                    <!--Search Area End-->
   
<div class="table table-responsive">

<table class="table">
 <thead class="tableClick">
    <tr>
    
  </tr>
    </thead>
    <tbody>
    
    </tbody>
</table>

       </div><!--end of .table-responsive-->
    <p id="search_prompt">Use Search Field Above to Find Attendees</p>
    </div>
       </div>
  </div>
    
<script>

const serialize = (obj) => (
        Object.keys(obj).reduce(
            (a, k) => { a.push(`${k}=${encodeURIComponent(obj[k])}`); return a; },
            []
        ).join('&')
    );

var tablefields= [];
var idList =[];
var requiredfields=[];
var editedAttendee;
var mode;
var tablestate;
var currentemail;
var currentemailid;
var active_button = false;


$(document).ready(function(){
    
tablestate = "checkin";
    
if(!window.localStorage.getItem("session_id")){
        
    window.location.href = "index.html";
} 

getCategories();


var interval = setInterval(refreshTimer, 120000);

function refreshTimer() {
    if($(searchfield).val() != 0){
            getAttendees(1);  
        }
      
    clearInterval(interval);
    interval = setInterval(refreshTimer, 120000);
}    

    $('#searchclear').click(function(){
       
        $('#searchfield').val('');
        
    });
    

    $('#submit_attn').click(function(){
   if(mode == "add"){
       
        addAttendee();
   }
    else{
       
        editAttendeewithId(editedAttendee); 
    }
     
});
    
    $('#btn-email').click(function(){
     
        var settings = {
  "async": true,
  "crossDomain": true,
  "url": "https://webservices.brightspotapps.com/api/event_emails/send_email/?app_id="+ window.localStorage.getItem("app_id") +"&session_id="+window.localStorage.getItem("session_id")+"&attendees%5B%5D="+editedAttendee+"&id="+currentemailid,
  "method": "GET",
  "headers": {
    "cache-control": "no-cache",
  }
}

$.ajax(settings).done(function (response) {
    
     if (!(typeof response === 'string' || response instanceof String))
            {
//                alert(typeof(incoming)); 
                indata = response;
            }
            else{
//               alert(typeof(incoming));  
                indata = JSON.parse(response);
            }
    
     var successflag = indata.success;
            
            if (successflag) {
                              
             alert("Email Sent Successfully");
            } 
    
}).fail(function(err) {
        
    alert(JSON.stringify(err.responseText));
 
}); 
    });
    
    $('#btn-delete').click(function(){
   
        deleteAttendee();
});
    
    $('tbody').on('click', '.trash_attendee', function () {
    
    var currentRow = $(this).closest('td').parent()[0].sectionRowIndex;
    editedAttendee = idList[currentRow];
    clearInterval(interval);
    
    $('#modaldelete').modal('show');
    
});
    
    $('#logout').click(function(){
        var that = this;
        event.preventDefault();
        //object
        $.post( "https://webservices.brightspotapps.com/api/auth/logout/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id")
            
}), {withCredentials: true}).then(function(incoming) {
            
           var indata;            
           
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
//                alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
//               alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            
            var successflag = indata.success;
            
            if (successflag) {
                              
                window.localStorage.removeItem("app_id");
                
                window.localStorage.removeItem("session_id"); 
                
                window.location.href = "login.html";
            
            } else {
                
                alert( "Sorry, but you are not eligible." );
    }
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });
            });
    
    $("#attendeebtn").click(function(){

   $('#modal_header').html('Add Attendee');
    createModal();
   $('#new_modal').modal('show');
    mode = "add";
    clearInterval(interval);    

});
    
    $('tbody').on('click', '.edit_button', function () {
    
    var currentRow = $(this).closest('td').parent()[0].sectionRowIndex;
    editedAttendee = idList[currentRow];
    
    $('#modal_header').html('Edit Attendee');
    createModal();
    populateModalData();
    clearInterval(interval);
});
    
    $('tbody').on('click', '#email_attn', function () {
    
    var currentRow = $(this).closest('td').parent()[0].sectionRowIndex;
    editedAttendee = idList[currentRow];
    
    getAttendeeEmail(editedAttendee);
        
    clearInterval(interval);
});
    
    $('#btnHide').click(function() {
//                $('td:nth-child(2)').hide();
                // if your table has header(th), use this
    
       if(active_button){
           
        if($(".checkin_col").is(":visible")){
            tablestate = "edit";
            $(".checkin_col").hide(); 
            $(".edit_col").show(); 
            $(".mode_button").html('Check-In View');
        } 
        else{
            tablestate = "checkin";
            $(".checkin_col").show();
            $(".edit_col").hide();
            $(".mode_button").html('Attendee View'); 
            
        }
    }
                
    });
  
    $('#searchsubmit').click(function() { 
        if($(searchfield).val() != 0){
            refreshTimer();
        }
    });

    $('tbody').on('click', '.checkbutton', function(){

var currentRow = $(this).closest('td').parent()[0].sectionRowIndex;
var that = this;  
    
if($( this ).hasClass( "redbtn" )){
    
    $.post( "https://webservices.brightspotapps.com/api/attendees/uncheck_in/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
            id: idList[currentRow]
            
}), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                                        
          $( that ).toggleClass( "redbtn" );
          $( that ).html("Check-In");
        }
        
        else {
                
            alert( "Sorry, but there was an error" );
    }
});  
}
else{
    $.post( "https://webservices.brightspotapps.com/api/attendees/check_in/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
            id: idList[currentRow]
            
}), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                                        
          $( that ).toggleClass( "redbtn" );
          $( that ).html("Checked-In");
        }
        
        else {
                
            alert( "Sorry, but there was an error" );
    }
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });  
}
 
});
    
    
//Email Functions
      
    function showEmailModal(){
    $('#modalemail').modal('show');
} 
        
    function createEmailMessage(email){
        
        
     $.post( "https://webservices.brightspotapps.com/api/event_emails/find_all/", serialize({ 
            //String
//        $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
        app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
}), {withCredentials: true}).then(function(incoming) {
           
           var indata;
            
            if (typeof incoming === 'string' || incoming instanceof String)
            {
               // alert("String");  
                indata = JSON.parse(incoming);
            }
            else{
                
               // alert("Object"); 
                indata = incoming;
            }
            
            var successflag = indata.success;
     
     if (successflag) {
         
         var records = indata.data.records;
         //alert(JSON.stringify(records));
         
         $.each(records, function(key, value){
             
             if (value.name == "Re-send E-Ticket Email Confirmation" || value.name == "Resend E-Ticket Email Confirmation"){
            
            currentemailid = value.id;
                 
             $('#modalemail .modal-body').html("Send \"" + value.name+ "\" to " + email+"?");
              
             showEmailModal();     
             }
             
             });                            
     } 
     });   
    }
    function getAttendeeEmail(attendee){
        
        $.post( "https://webservices.brightspotapps.com/api/attendees/find/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
            id: attendee
            
}), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;
            
          // alert("We got Data")  
            
           
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            var successflag = indata.success;
            
            if (successflag) {
             
//            alert(JSON.stringify(indata.data));
                var attendeeemail = indata.data.email;
                var populatedata =[];            
                createEmailMessage(attendeeemail);
            }
        
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });
    
    }

    
//Basic Setup    
    function getCategories(){
    $("#event_title").html(window.localStorage.getItem("event_name"));    
        
    $.post( "https://webservices.brightspotapps.com/api/events/find/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
            
            
}), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;
            
          // alert("We got Data")  
            
           
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            var successflag = indata.success;
            
            if (successflag) {
                                              
                 var categories = indata.data.attendee_fields;
    var fields = [];
    $.each(indata.data.attendee_admin_fields, function(key,val){
        if(fields.length < 4 && val != 'registration_status' && val != 'check_in_status'){
            fields.push(val);
        }
    });
    //if check in view
    fields.push('registration_status');
                tablefields = fields;
                
                
                
                
//         alert(JSON.stringify(categories));
         console.log(JSON.stringify(tablefields)); 
                
            $.each(categories, function(key, value){
                
               var requiredstring = JSON.stringify(value["validation_rules"]["admin_event_attendees/add"]);
                
//                alert(requiredstring);
                
                if (~requiredstring.indexOf("required")){
                    
                    requiredfields.push([value.name,value.machine_name,value.type,value.options]);
                    
                }
                
            }); 
                
//                alert(requiredfields);
                //create fields;
                
                
        $.each(fields, function(idx, field){
            
            $.each(categories, function(key, value){
                
                
                if(field == value.machine_name){
                    
                    //alert(value.name);
                    var markup = "<th>"+ value.name +"</th>";
                    $("table thead tr").append(markup);
                    
                }
             
              
        });
           }); 
                
            var markupbuttons = "<th class='checkin_col'>Check-In</th><th class='edit_col'>Actions</th>"
            $("table thead tr").append(markupbuttons);
//            getAttendees(1);
                
             if(tablestate == "checkin"){
//                tablestate = "edit";
                
                $(".mode_button").html('Attendee View'); 
                $(".checkin_col").show(); 
                $(".edit_col").hide(); 
                 
            }
            else{
//                tablestate = "checkin";
                $(".checkin_col").hide(); 
                $(".edit_col").show(); 
                $(".mode_button").html('Check-In View'); 
               
            }
            
            }
        
            getCheckIn();
                
                
                
        
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    }); 
} 
    
    function deleteAttendee(){
        
         $('#modal_load').modal('show');
        
         $.post( "https://webservices.brightspotapps.com/api/attendees/delete/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
            id: editedAttendee
            
}), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;
            
          // alert("We got Data")  
            
           
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            var successflag = indata.success;
            
            if (successflag) {
                
                alert("Attendee Deleted");
                if($(searchfield).val() !=0){
                refreshTimer();
                }
                $('#modal_load').modal('hide');
                
                
            } else {
                
            alert( "Sorry, but there was an error" );
    }
        
             
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });
         
     }
    
    function getRegistered(){
    
        var post_code= serialize({
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),}) ;
        
        post_code += "&search[registration_status]=REGISTERED";
        
    $.post( "https://webservices.brightspotapps.com/api/attendees/count/", post_code
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
, {withCredentials: true}).then(function(incoming) {
           
        
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                                        
         var register_count = indata.data;
         $("#rgstrd").html("Registered: " + register_count);
         getCount()
        }
        
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    }); 
}
    
    function getCheckIn(){
     var post_code= serialize({
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id")}) ;
        
        post_code += "&search[check_in_status]=CHECKED-IN";
        
    $.post( "https://webservices.brightspotapps.com/api/attendees/count/", post_code
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
    , {withCredentials: true}).then(function(incoming) {
           
        
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                                        
         var check_in_count = indata.data;
         $("#chckd").html("Checked-In: " + check_in_count);
         getRegistered();
        
        
        }
        
        
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });
}    
    
    function getCount(){
     var post_code= serialize({
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id")}) ;
        
    $.post( "https://webservices.brightspotapps.com/api/attendees/count/",  post_code
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
        , {withCredentials: true}).then(function(incoming) {
           
        
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                                        
         var check_in_count = indata.data;
          $("#ttlcnt").html("All Attendees: " + check_in_count);
         
        }
        
        
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });
}    

//Attendee Actions    
    function getAttendees(page_num) {

        
    var currentpage;
    
    
    
    if (page_num == 1){
       idList = [];
       $("table tbody tr").remove();
       currentpage = 1; 
       // $('#modal_load').modal('show');
     
        
        $('#button-symbol').removeClass().addClass("fa fa-circle-o-notch fa-spin");
        
        
        
    }
    
    else{
        
       currentpage = page_num;
        
    }

   
        
  var post_code = serialize({
            app_id: window.localStorage.getItem("app_id"),
            limit: 275,
            session_id: window.localStorage.getItem("session_id"),
            page: currentpage
});
    
 post_code += "&search[$or][]["+tablefields[0]+"]="+encodeURIComponent($(searchfield).val());
 post_code += "&search[$or][]["+tablefields[1]+"]="+encodeURIComponent($(searchfield).val());
 post_code += "&search[$or][]["+tablefields[2]+"]="+encodeURIComponent($(searchfield).val());
 post_code += "&search[$or][]["+tablefields[3]+"]="+encodeURIComponent($(searchfield).val());
    
        //String
//  $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( )));
    //alert(post_code);
    $.post( "https://webservices.brightspotapps.com/api/attendees/find_all/", post_code, {withCredentials: true}).then(function(incoming) {
       
           
           var indata;
            
          // alert("We got Data")  
            
           
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                   
         var records = indata.data.records;
         //alert(JSON.stringify(records));
         var eventsJsonArray = [];
         var totalpages = indata.data.total_pages;
         var total_count = indata.data.total_count;
         
//        $("#ttlcnt").html("All Attendees: " + total_count);
        
        $.each(records, function(key, record){
            
            idList.push(key);
            
            $.each(tablefields, function(idx, value){
                var markup; 
                if(idx == 0){
                    markup = "<tr class='"+ idList.length +"'><td>"+ record[value] +"</td></tr>";
                    $("table tbody").append(markup);   
                }
                else{
                
                    markup = "<td>"+ record[value] +"</td>";
                    $("table tbody tr:last").append(markup);   
                }
              
            
                 });
            
            
            
            var addedmarkup;
            if(record.check_in_status =='CHECKED-IN'){
              addedmarkup = "<td class='checkin_col'><button class='checkbutton redbtn greenbtn btn'>Checked-In</button></td><td class='edit_col'><button class='edit_button btn'>Edit</button><button type='button' id='email_attn' class='btn modal_btn'><span class='glyphicon glyphicon-envelope'></span></button><input class='trash_attendee' type='image' src='img/trash_recyclebin_empty_closed.png' /></td></tr>"; 
            }
            else{
                addedmarkup = "<td class='checkin_col'><button class='checkbutton greenbtn btn'>Check-In</button></td><td class='edit_col'><button class='edit_button btn'>Edit</button><button type='button' id='email_attn' class='btn modal_btn'><span class='glyphicon glyphicon-envelope'></span></button><input class='trash_attendee' type='image' src='img/trash_recyclebin_empty_closed.png' /></td></tr>";   
            }
            
            $("table tbody tr:last").append(addedmarkup);
            
        });
           
            if(currentpage != totalpages && totalpages != 0)
                {
                    
                    currentpage = currentpage + 1;
                    getAttendees(currentpage);   
                }
        else{
              if(totalpages == 0){
                  alert("No Attendees Found");
              }
            
            $('#button-symbol').removeClass().addClass("glyphicon glyphicon-search");
            
            if(tablestate == "checkin"){
            $(".checkin_col").show(); 
            $(".edit_col").hide(); 
            $(".mode_button").html('Attendee View'); 
            //$("#table td:nth-child(4),th:nth-child(4)").hide();
          // $("#table td:nth-child(5),th:nth-child(5)").show();
        } 
        else{
            tablestate = "checkin";
            $(".checkin_col").hide();
            $(".edit_col").show();
            $(".mode_button").html('Check-In View'); 
            //$("#table td:nth-child(4),th:nth-child(4)").show();
            //$("#table td:nth-child(5),th:nth-child(5)").hide();
            
        }
            
        }
           
           
        
        }
        
        
    
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    });
       active_button = true;
}    
    
    function addAttendee(){
        
            //$('#modal_load').modal('show');
        
            var post_code = {};
                 $(".form_group input[type=text],.form_group select, .form_group input[type=radio]:checked,input[type=checkbox]:checked").each(function(key,val){
                    post_code[$(this).data('machine_name')] = $(this).val();
                 });
         post_code.app_id = window.localStorage.getItem("app_id"),
         post_code.session_id = window.localStorage.getItem("session_id");
        
//        alert( serialize(post_code));
          
    $.post( "https://webservices.brightspotapps.com/api/attendees/add/", serialize(post_code), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
                                        
         alert("Attendee Created!");
        
        
        if($(searchfield).val() === 0){
            refreshTimer();
        }
         
        
        $('#new_modal').modal('hide');
        
        }
    
        $('#modal_load').modal('hide');
}) .fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    }); 
        
        
    } 
    
    function editAttendeewithId(attendee_id){

        //$('#modal_load').modal('show');
        
            var post_code = {};
                 $(".form_group input[type=text],.form_group select, .form_group input[type=radio]:checked,input[type=checkbox]:checked").each(function(key,val){
                    post_code[$(this).data('machine_name')] = $(this).val();
                 });
         post_code.app_id = window.localStorage.getItem("app_id");
         post_code.session_id = window.localStorage.getItem("session_id");
         post_code.id = attendee_id;
        
//        alert(serialize(post_code));
          
    $.post( "https://webservices.brightspotapps.com/api/attendees/update/", serialize(post_code), {withCredentials: true}).then(function(incoming) {
           
           var indata;   
                   
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            //alert(JSON.stringify(indata));
            var successflag = indata.success;
            
    if (successflag) {
          //$('#modal_load').modal('hide');      
         alert("Attendee Edited!");
         if($(searchfield).val() != 0){
            refreshTimer();
        }
         $('#new_modal').modal('hide');
        
        }
        
}).fail(function(err) { 
        
        alert(JSON.stringify(err.responseJSON.errors).replace("{","").replace("}",""));    
        
    }); 
        
        
    }
 
    
//Modal Function    
    function populateModalData (){
    
    $.post( "https://webservices.brightspotapps.com/api/attendees/find/", serialize({ 
        //String
//      $.post( "https://webservices.brightspotevents.com/api/applications/find_all/", serialize( {
            
            app_id: window.localStorage.getItem("app_id"),
            session_id: window.localStorage.getItem("session_id"),
            id: editedAttendee
            
}), {withCredentials: true}).then(function(incoming) {
           
        
           var indata;
            
          // alert("We got Data")  
            
           
            if (!(typeof incoming === 'string' || incoming instanceof String))
            {
               // alert(typeof(incoming)); 
                indata = incoming;
            }
            else{
              // alert(typeof(incoming));  
                indata = JSON.parse(incoming);
            }
            
            var successflag = indata.success;
            
            if (successflag) {
             
//            alert(JSON.stringify(indata.data));
                var fields = indata.data;
                var populatedata =[];
//         alert(JSON.stringify(categories));
//         alert(JSON.stringify(requiredfields)); 
                
        $.each(requiredfields, function(idx, value){
                
               var requiredstring = value[1];
            
            $.each(fields, function(key, field){
                
                
                    if(key == requiredstring){
                
                    populatedata.push([requiredstring,field]);
                    
                }
            });
            }); 
               // alert(JSON.stringify(populatedata));
                populateModal(populatedata);
                mode = "edit";
                $('#new_modal').modal('show');
                
                
            } 
        
}).fail(function(err) {
//            alert(JSON.stringify(err.responseText));
    // handle any error resulting from any of the above calls    
});   
}
    
    function populateModal(data){
        //data [{key:val},{key:val}]
        // Incoming data gets looped through and populates form
    
        var element;
        $(".form_group input[type=text],.form_group select, .form_group input[type=radio],input[type=checkbox]").each(function(key,val){
            element = $(this);
            
           //alert(JSON.stringify(element.data('machine_name')));
            
            $.each(data, function(key,value){
                
                
              if(element.data('machine_name') == value[0]) {
                    
                  if (element.is('input[type=text]')|| element.is("select")){
                    element.val(value[1]);
                 }
                 else{
                     if(element.attr('class') == value[1]){
                         element.prop("checked", true);
                     }
                     
                 }
              }
            });
        
            });   
    }
    
    function createModal(){
        
        var selectgroup;
        var textgroup;
        var radiogroup;
        var checkgroup;
        $('.modal-body form').empty();
        
         $.each(requiredfields, function(idx, value){
                
//             requiredfields.push([value.name,value.machine_name,value.type,value.options);
//                '<form role=''form>
             
                if (value[2] == 'text'){
                   
                 textgroup = "<div class='form-group'><label for='exampleInputEmail1'>"+value[0]+"</label><input type='text'  class='form-control "+value[1]+"'data-machine_name='"+value[1]+"' placeholder='Enter "+value[0]+"'/>";

                 $(".modal-body form").append(textgroup);
                }
             
             
             else{
                 
                 if(value[2] == 'select'){
                     
                   selectgroup =  "<div class='form-group'><label for='exampleSelect1'>"+value[0]+"</label><select data-machine_name='"+value[1]+"' class='"+value[1]+"'>";
                  
                  var appendoption;
                  
                 $.each(value[3], function(idx, value){
                    
                    appendoption =  "<option>"+value+"</option>";
                    selectgroup = selectgroup + appendoption;
                 });
                     
                    selectgroup = selectgroup + "</select></div>";
                     $(".modal-body form").append(selectgroup);
                 }
                 
                 else if(value[2] == 'checkbox'){
                    
                    var appendcheck;
                     
                    checkgroup = "<div class='"+value[1]+"'><label for=''>"+value[0]+"</label>" 
                    
                    $.each(value[3], function(idx, value){
                    
                        appendcheck = "<input data-machine_name='"+value[1]+"' type='checkbox' class='"+value+">"+value+"</label>";
                        
                        checkgroup = checkgroup + appendcheck;
                    });
                     
                     checkgroup = checkgroup +  "</div>";
                     $(".modal-body form").append(checkgroup);
                     
                 }
                 
                 
                 else if(value[2] == 'radio'){
                     
                     var appendradio;
                     
                    radiogroup = "<div class='form-radio'><label for=''>"+value[0]+"</label>" 
                    
                    $.each(value[3], function(idx, subvalue){
                    
                        appendradio = "<label class='radio-inline'><input data-machine_name='"+value[1]+"' type='radio'name='"+value[1]+"' class='"+subvalue+"' value='"+subvalue+"'/>"+subvalue+"</label>";
                        
                        radiogroup = radiogroup + appendradio;
                    });
                     
                     radiogroup = radiogroup +  "</div>";
                     $(".modal-body form").append(radiogroup);
                 }
                
             }
                
            });     
    }
        
});

$( window ).unload(function() {
 if(window.localStorage.getItem("remembered")=="no"){
    window.localStorage.removeItem("session_id"); 
 }
    
});
    
    </script>
    <script type="text/javascript" src="cordova.js"></script>
    <script type="text/javascript" src="js/index.js"></script>
    <script type="text/javascript">
        app.initialize();
    </script>
</body>

</html>